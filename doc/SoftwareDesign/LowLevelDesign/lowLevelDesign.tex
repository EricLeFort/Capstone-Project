\documentclass[titlepage]{article}
\usepackage[left=15mm,right=15mm,top=1in,bottom=1in]{geometry}
\usepackage{framed}
\usepackage{caption}
\usepackage{amsmath}
\usepackage{multicol}
\usepackage{color}
\usepackage{graphicx}
\usepackage{array}
\usepackage{listings}
\usepackage[figuresleft]{rotating}

\newcolumntype{C}[1]{>{\centering\arraybackslash} m{#1cm}}
\graphicspath{{./img/}}

\setlength{\columnseprule}{1pt}
\def\columnseprulecolor{\color{black}}

\makeindex

\title{Autonomous Pool Playing Robot\\~\\Low-Level Software Design}
\author{
	Eric Le Fort\\leforte@mcmaster.ca\\1308609\\~\\\and
	Max Moore\\moorem8@mcmaster.ca\\1320009
}
 
\begin{document}
\maketitle
\tableofcontents
\listoftables
\listoffigures


\vfill
\begin{table}[!htbp]
\centering
\begin{tabular}{| C{3} | C{2} | C{5} | C{2.5} |}\hline
	Date			&Revision \#	&Comments						&Authors\\\hline
	25/12/2016		&0				&- Initial document creation	&Eric Le Fort\\\hline
\end{tabular}
\caption{Revision History}
\end{table}
\newpage
 
\section{Introduction}
This document will outline the low-level software design for a autonomous pool-playing robot. The purpose of this document will be to document the decisions made concerning the system's design as well as provide enough detail so that the programming of the system can be as trivial as possible.
\subsection{System Description}
A system description can be found in the /textit{High-Level Software Design} document for this system.
\subsection{Overview}
This document will begin by providing a detailed class diagram of the classes in the system. Then, each module will be covered in more detail such as the module's responsibilities, secrets, Interface Specification (MIS), and Internal Design (MID). Lastly, the document will discuss the scheduling of tasks and provide state charts and sequence diagrams to help illustrate the scheduling.
\subsection{Naming Conventions \& Definitions}
This section outlines the various definitions, acronyms and abbreviations that will be used throughout this document in order to familiarize the reader prior to reading.
\subsubsection{Definitions}
Table \ref{tab:Definitions} lists the definitions used in this document. The definitions given below are specific to this document and may not be identical to definitions of these terms in common use. The purpose of this section is to assist the user in understanding the requirements for the system.
\begin{table}[h!]
\centering
\caption{Definitions}
\begin{tabular}{| C{6} | p{6cm} |}\hline
	\textbf{Term}	&\textbf{\centering Meaning}\\\hline
	X-axis					&Distance along the length of the pool table\\\hline
	Y-axis					&Distance across the width of the pool table\\\hline
	Z-axis					&Height above the pool table\\\hline
	End-effector			&The end of the arm that will strike the cue ball\\\hline
	$\theta$				&Rotational angle of end-effector\\\hline
	Cue 					&End-effector\\\hline
	Personal Computer		&A laptop that will be used to run the more involved computational tasks such as visual recognition and the shot selection algorithm\\\hline
	Camera					&Some form of image capture device (e.g. a digital camera, smartphone with a camera, etc.)\\\hline
	Table State				&The current positions of all the balls on the table\\\hline
	Entity					&Classes that have a state, behaviour and identity (e.g. Book, Car, Person, etc.)\\\hline
	Boundary				&Classes that interact with users or external systems\\\hline
	Double					&Double-precision floating point numbers\\\hline
\end{tabular}
\label{tab:Definitions}
\end{table}
\newpage

\subsubsection{Acronyms \& Abbreviations}
Table \ref{tab:Acronyms} lists the acronyms and abbreviations used in this document.
\begin{table}[h!]
\centering
\caption{Acronyms and Abbreviations}
\begin{tabular}{| p{6cm} | p{6cm} |}\hline
	\textbf{Acronym/Abbreviation}	&\textbf{Meaning}\\\hline
	VR								&Visual Recognition\\\hline
	PC								&Personal Computer\\\hline
	$\mu$C							&Micro-Controller\\\hline
	CRC								&Class Responsibility Collaboration\\\hline
\end{tabular}
\label{tab:Acronyms}
\end{table}

\section{Detailed Class Diagram}~\\
\begin{center}
	\includegraphics[width=\textwidth]{DetailedClassDiagram.png}
\captionof{figure}{The system's detailed class diagram.}
\label{fig:detailedClassDiagram}
\end{center}
\newpage

\section{Module Guide}
This section discusses the various modules that this system is comprised of. The modules are divided based on which program they belong to. For each module, its responsibilities, secrets, MIS, and MID will be outlined.
\subsection{Camera Modules}
The following is the module contained within the Camera subsystem.
\subsubsection{EventHandler}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Listen for request from PC Communicator
	\item[-] Take a photo
	\item[-] Communicate photo to PC Communicator
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] Picture-taking process
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module is an always-running program which executes the function of taking a picture and communicating it back to the requesting program. While this module is not performing the previous function, it will be listening for a request to be made.
\\\\
\textbf{MID}\\[2mm]
The state charts below provide a succinct depiction of this module's internal design.
\\\\
\subsection{PC VR Program Modules}
The following is the module contained within the PC VR subsystem.
\subsubsection{TableStateVR}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Read image from a file
	\item[-] Locate balls using VR
	\item[-] Determine ball identities
	\item[-] Write table state to a file
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] Object detection algorithm
	\item[-] Ball identification algorithm
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module takes in an image of a pool table and analyzes it in order to return the locations and identities of each of the pool balls on the table.
\\\\
\textbf{MID}\\[2mm]
This module has 4 main steps. First it must read in the image from a predetermined file location. Then it locates the pool balls in that picture using a Visual Recognition object detection algorithm (supplied by a MATLAB library). Next, it will identify which ball is which according to comparing pixel colours within the detected objects to the colours of different pool balls using a LAB colour space. Lastly it will write these results to a file.\\~\\
The following pseudocode better describes this process:
\begin{lstlisting}
read image from file (path to file);
locate balls (image);

for every detected object:
	sample pixels within;
	
	while (pixels not similar to ball archetype AND arcge);
		increment archetype being checked;
		
	if (index out of range):
		raise unidentifiable ball error;
	else:
		results[index for this ball] = this object's location;

return results;
\end{lstlisting}~\\
\subsection{PC Controller Modules}
The following are the modules contained within the PC Controller subsystem.
\subsubsection{InferenceEngine}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Calculate the best shot to be made
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] Algorithm to choose which shots to simulate
	\item[-] The computer's ball type (i.e. stripes or solids)
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module allows for specification of a TableState through the use of a 2-D array of doubles. Using that TableState, the module will simulate various potential shots in order to determine an optimal one which is then accessible to other classes.
\\\\
\textbf{MID}\\[2mm]
\\\\%TODO
\subsubsection{PCCommunicator}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Listens for request from $\mu$C
	\item[-] Sends confirmation of receipt to $\mu$C
	\item[-] Sends shot specification to $\mu$C
	\item[-] Listens for confirmation of receipt from $\mu$C
	\item[-] Sends image capture request to camera
	\item[-] Listens for response from camera
	\item[-] Initiate the PC VR program
	\item[-] Read table state from file
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] Receipt confirmation message contents
	\item[-] Maximum time awaiting a response
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module is an always-running process which communicates with the various programs in this system while also providing control flow for the PC Controller program.
\\\\
\textbf{MID}\\[2mm]
The state charts below provide a succinct depiction of this module's internal design.
\\\\
\subsubsection{SimulationInstance}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Maintain the positions and velocities of the balls on the table at the current time step
	\item[-] Update the positions and velocities of the balls on the table after a time step
	\item[-] Keep track of whether there is still movement happening
	\item[-] Keep track of the scoring of the simulation (of a shot)
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] The method of calculating a shot's score
	\item[-] Shot simulation algorithm
	\item[-] Physical constants
	\item[-] Simulation time step
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module handles the physics simulation involved with taking a shot while also scoring the shot according to various criteria. The state is updated for a new time step by calling the appropriate command. Once it returns \textit{false}, there is no further motion and the simulation is complete.
\\\\
\textbf{MID}\\[2mm]
\\\\%TODO
\subsection{$\mu$C Modules}
The following are the modules contained within the $\mu$C subsystem.
\subsubsection{Controller}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Control flow of program operation
	\item[-] Interrupt operation if cancel instruction is received
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] Set movement positions (for ``move'' commands)
	\item[-] Instruction dispatch process
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module handles the control flow for the $\mu$C Program including determining appropriate movement and creation of interrupts when necessary. 
\\\\
\textbf{MID}\\[2mm]
\\\\%TODO
\subsubsection{SensorMonitor}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Sensing signals from buttons
	\item[-] Sensing signals from calibration sensors
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] The method of noticing signals
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module monitors the control signals coming from the buttons and calibration sensors and notifies the Controller when one of these sensors are activated.
\\\\
\textbf{MID}\\[2mm]
The state charts below provide a succinct depiction of this module's internal design.
\\\\
\subsubsection{ShotInterpreter}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Translate shot instruction into list of appropriate signals
	\item[-] Control translational motors
	\item[-] Control rotational motor
	\item[-] Control pneumatic end-effector
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] Algorithm to determine appropriate movement
	\item[-] Method of transmitting signals to machine
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module uses a movement specification that it is provided in order to compute and generate the signals necessary to have the machine perform the required motion.
\\\\
\textbf{MID}\\[2mm]
\\\\%TODO
\subsubsection{$\mu$CCommunicator}
\textbf{Responsibilities}
\begin{itemize}
	\item[-] Send shot calculation request to the PC Controller program
	\item[-] Receive confirmation of receipt from PC Controller program
	\item[-] Receive shot specification from PC Controller program
	\item[-] Send confirmation of receipt to PC Controller program 
\end{itemize}~\\
\textbf{Secrets}
\begin{itemize}
	\item[-] Receipt confirmation message contents
	\item[-] Maximum time awaiting a response
\end{itemize}~\\
\textbf{MIS}\\[2mm]
This module handles communicating with the PC Controller Program in order to compute the optimal shot to take.
\\\\
\textbf{MID}\\[2mm]
The state charts below provide a succinct depiction of this module's internal design.
\\\\
\newpage

\section{Scheduling of Tasks}
The goal of this section is to outline the ordering, maximum allowable time frames, and the prioritization of tasks in this program.
%TODO Describe scheduling, especially timing constraints and the like.
\subsection{State Charts}
The following charts illustrate the lifecycle of all relevant classes in this system. This section is meant to depict a more isolated picture of how each class will operate.\\[15mm]
\begin{center}
	\includegraphics[width=0.6\textwidth]{ControllerStateChart.png}
\captionof{figure}{A state chart for the Controller class.}
\label{fig:ControllerStateChart}
\end{center}
\newpage

\begin{center}
	\includegraphics[width=0.8\textwidth]{ShotInterpreterStateChart.png}
\captionof{figure}{A state chart for the ShotInterpreter class.}
\label{fig:ShotInterpreterStateChart}
\end{center}
\begin{multicols}{2}
~\vfill
\begin{center}
	\includegraphics[width=0.4\textwidth]{SensorMonitorStateChart.png}
\captionof{figure}{A state chart for the SensorMonitor class.}
\label{fig:SensorMonitorStateChart}
\end{center}
~\vfill
\begin{center}
	\includegraphics[width=0.35\textwidth]{uCCommunicatorStateChart.png}
\captionof{figure}{A state chart for the $\mu$CCommunicator class.}
\label{fig:uCCommunicatorStateChart}
\end{center}
\end{multicols}
\newpage

~\vfill
\begin{center}
	\includegraphics[width=0.9\textwidth]{PCCommunicatorStateChart.png}
\captionof{figure}{A state chart for the PCCommunicator class.}
\label{fig:PCCommunicatorStateChart}
\end{center}
~\vfill
\newpage

~\vfill
\begin{center}
	\includegraphics[width=0.6\textwidth]{InferenceEngineStateChart.png}
\captionof{figure}{A state chart for the InferenceEngine class.}
\label{fig:InferenceEngineStateChart}
\end{center}
~\vfill
\newpage

\begin{multicols}{2}
\begin{center}
	\includegraphics[width=0.175\textwidth]{TableStateVRStateChart.png}
\captionof{figure}{A state chart for the TableStateVR class.}
\label{fig:TableStateVRStateChart}
\end{center}
\columnbreak
~\vspace{15mm}
\begin{center}
	\includegraphics[width=0.3\textwidth]{EventHandlerStateChart.png}
\captionof{figure}{A state chart for the EventHandler class.}
\label{fig:EventHandlerStateChart}
\end{center}
\end{multicols}
\newpage

\subsection{Sequence Diagrams}
The following are various sequence diagrams for different actions the system is required to perform. These diagrams are meant to provide better context for how the classes interact with each other to perform certain tasks.\vfill
\begin{center}
	\includegraphics[width=0.6\textwidth]{MoveSequenceDiagram.png}
\captionof{figure}{A sequence diagram for the ``move'' operation.}
\label{fig:MoveSequenceDiagram}
\end{center}
~\vfill
\begin{center}
	\includegraphics[width=0.6\textwidth]{cancelSequenceDiagram.png}
\captionof{figure}{A sequence diagram for the ``cancel'' operation.}
\label{fig:CancelSequenceDiagram}
\end{center}
~\vfill
\newpage

\begin{sidewaysfigure}
	\begin{center}
		\includegraphics[width=\textwidth]{TakeShotSequenceDiagram.png}
	\captionof{figure}{A sequence diagram for the ``take shot'' operation.}
	\label{fig:TakeShotSequenceDiagram}
	\end{center}
\end{sidewaysfigure}

\end{document}

